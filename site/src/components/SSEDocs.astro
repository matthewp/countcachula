---
import { Code } from 'astro-expressive-code/components';

const installCode = 'npm install @countcachula/sse';

const basicSetupCode = `import { CacheHub } from '@countcachula/sse';
import { streamSSE } from 'hono/streaming';

const hub = new CacheHub();

app.get('/api/cache-events', (c) => {
  return streamSSE(c, async (stream) => {
    hub.addConnection(stream);

    c.req.raw.signal.addEventListener('abort', () => {
      hub.removeConnection(stream);
    });

    // Keep connection alive...
  });
});`;

const addConnectionCode = 'hub.addConnection(stream);';

const removeConnectionCode = 'hub.removeConnection(stream);';

const invalidateCode = `// After a mutation
app.patch('/api/items/:id', async (c) => {
  const id = c.req.param('id');
  // ... update logic ...

  await hub.invalidate([\`item:\${id}\`, 'items-list']);
  return c.json({ success: true });
});`;

const preloadHintCode = `// Suggest routes to preload
const itemUrls = items.map(item => \`/api/items/\${item.id}\`);
await hub.preloadHint(itemUrls);`;
---

<section id="sse-api" class="py-20 px-6 bg-gradient-to-br from-purple-50 to-pink-50">
  <div class="max-w-5xl mx-auto">
    <h2 class="text-5xl md:text-6xl font-black text-purple-900 mb-4 transform rotate-1">
      <span class="inline-block bg-orange-500 text-white px-6 py-2 rounded-xl">SSE API</span>
    </h2>
    <p class="text-xl text-gray-700 mb-12">Server-side SSE management for cache invalidation</p>

    <!-- Installation -->
    <div class="mb-12 bg-amber-50 rounded-2xl p-8 border-4 border-orange-500 shadow-xl">
      <h3 class="text-2xl font-bold text-orange-900 mb-4">ðŸ“¦ Installation</h3>
      <Code code={installCode} lang="bash" />
    </div>

    <!-- CacheHub -->
    <div class="mb-12 bg-amber-50 rounded-2xl p-8 border-4 border-purple-500 shadow-xl">
      <h3 class="text-3xl font-bold text-purple-900 mb-4">CacheHub</h3>
      <p class="text-lg text-gray-700 mb-4">
        Central hub for managing SSE connections and broadcasting cache events.
      </p>

      <div class="bg-purple-50 rounded-xl p-6 mb-4">
        <h4 class="font-bold text-gray-900 mb-2">Basic Setup:</h4>
        <Code code={basicSetupCode} lang="js" />
      </div>
    </div>

    <!-- Methods -->
    <div class="mb-12 bg-amber-50 rounded-2xl p-8 border-4 border-red-500 shadow-xl">
      <h3 class="text-3xl font-bold text-red-900 mb-4">Methods</h3>

      <div class="space-y-6">
        <!-- addConnection -->
        <div class="bg-red-50 rounded-xl p-6">
          <h4 class="text-xl font-bold text-red-900 mb-2">addConnection(stream)</h4>
          <p class="text-gray-700 mb-3">Register a new SSE connection.</p>
          <Code code={addConnectionCode} lang="js" />
        </div>

        <!-- removeConnection -->
        <div class="bg-orange-50 rounded-xl p-6">
          <h4 class="text-xl font-bold text-orange-900 mb-2">removeConnection(stream)</h4>
          <p class="text-gray-700 mb-3">Unregister an SSE connection.</p>
          <Code code={removeConnectionCode} lang="js" />
        </div>

        <!-- invalidate -->
        <div class="bg-yellow-50 rounded-xl p-6">
          <h4 class="text-xl font-bold text-yellow-900 mb-2">invalidate(tags)</h4>
          <p class="text-gray-700 mb-3">Broadcast cache invalidation to all clients.</p>
          <Code code={invalidateCode} lang="js" />
        </div>

        <!-- preloadHint -->
        <div class="bg-purple-50 rounded-xl p-6">
          <h4 class="text-xl font-bold text-purple-900 mb-2">preloadHint(routes)</h4>
          <p class="text-gray-700 mb-3">Send preload hints to connected clients.</p>
          <Code code={preloadHintCode} lang="js" />
        </div>
      </div>
    </div>

    <!-- Features -->
    <div class="bg-amber-50 rounded-2xl p-8 border-4 border-green-500 shadow-xl">
      <h3 class="text-3xl font-bold text-green-900 mb-4">âœ¨ Features</h3>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-green-50 rounded-xl p-6">
          <h4 class="font-bold text-green-900 mb-2">ðŸ§¹ Automatic Cleanup</h4>
          <p class="text-gray-700">Dead connections are automatically removed during broadcasts</p>
        </div>
        <div class="bg-blue-50 rounded-xl p-6">
          <h4 class="font-bold text-blue-900 mb-2">ðŸ”Œ Framework Agnostic</h4>
          <p class="text-gray-700">Works with any SSE stream implementing writeSSE</p>
        </div>
        <div class="bg-purple-50 rounded-xl p-6">
          <h4 class="font-bold text-purple-900 mb-2">ðŸŽ¯ Simple API</h4>
          <p class="text-gray-700">Clean methods for invalidation and preloading</p>
        </div>
        <div class="bg-pink-50 rounded-xl p-6">
          <h4 class="font-bold text-pink-900 mb-2">ðŸ“˜ Type Safe</h4>
          <p class="text-gray-700">Full TypeScript support included</p>
        </div>
      </div>
    </div>
  </div>
</section>
