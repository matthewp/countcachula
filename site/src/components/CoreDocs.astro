---
import { Code } from 'astro-expressive-code/components';

const installCode = 'npm install @countcachula/core';

const fetchUsageCode = `import * as CountCachula from '@countcachula/core';

const request = new Request('/api/items');
const observable = CountCachula.fetch(request);

observable.observe(async (response) => {
  const data = await response.json();
  console.log(data); // May emit twice: cached + fresh
});`;

const observableCleanupCode = `const observable = CountCachula.fetch(request);

const unsubscribe = observable.observe((response) => {
  // Handle response
});

// Later: cleanup
unsubscribe();`;

const connectSignatureCode = 'connect(endpoint: string, options?: ConnectOptions): Promise<Connection>';

const connectUsageCode = `const connection = await CountCachula.connect('/api/cache-events', {
  preload: {
    onInvalidate: false,
    onHint: true,
    maxConcurrent: 3,
  },
});

// Later: disconnect
connection.close();`;
---

<section id="core-api" class="py-20 px-6 bg-gradient-to-br from-orange-50 to-yellow-50">
  <div class="max-w-5xl mx-auto">
    <h2 class="text-5xl md:text-6xl font-black text-purple-900 mb-4 transform -rotate-1">
      <span class="inline-block bg-purple-600 text-white px-6 py-2 rounded-xl">Core API</span>
    </h2>
    <p class="text-xl text-gray-700 mb-12">Client-side caching with stale-while-revalidate pattern</p>

    <!-- Installation -->
    <div class="mb-12 bg-purple-50 rounded-2xl p-8 border-4 border-purple-600">
      <h3 class="text-2xl font-bold text-purple-900 mb-4">ðŸ“¦ Installation</h3>
      <Code code={installCode} lang="bash" />
    </div>

    <!-- fetch() -->
    <div class="mb-12 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-2xl p-8 border-4 border-orange-500">
      <h3 class="text-3xl font-bold text-orange-900 mb-4">fetch()</h3>
      <p class="text-lg text-gray-700 mb-4">
        Drop-in replacement for fetch with stale-while-revalidate caching.
      </p>

      <div class="bg-amber-50 rounded-xl p-6 mb-4">
        <h4 class="font-bold text-gray-900 mb-2">Usage:</h4>
        <Code code={fetchUsageCode} lang="js" />
      </div>

      <div class="bg-orange-100 rounded-xl p-4">
        <p class="text-sm text-orange-900">
          <strong>Note:</strong> Only supports GET requests. Use regular fetch() for mutations.
        </p>
      </div>
    </div>

    <!-- CacheObservable -->
    <div class="mb-12 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-8 border-4 border-purple-500">
      <h3 class="text-3xl font-bold text-purple-900 mb-4">CacheObservable</h3>
      <p class="text-lg text-gray-700 mb-4">
        Observable pattern for cache responses. Emits up to 2 values: cached response (if available) + fresh response.
      </p>

      <div class="bg-amber-50 rounded-xl p-6 mb-4">
        <h4 class="font-bold text-gray-900 mb-2">Methods:</h4>
        <ul class="space-y-2 text-gray-700">
          <li><code class="bg-purple-100 px-2 py-1 rounded">observe(callback)</code> - Subscribe to cache updates</li>
          <li><code class="bg-purple-100 px-2 py-1 rounded">Returns: () => void</code> - Unsubscribe function</li>
        </ul>
      </div>

      <div class="bg-amber-50 rounded-xl p-6">
        <h4 class="font-bold text-gray-900 mb-2">Example with cleanup:</h4>
        <Code code={observableCleanupCode} lang="js" />
      </div>
    </div>

    <!-- connect() -->
    <div class="mb-12 bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl p-8 border-4 border-red-500">
      <h3 class="text-3xl font-bold text-red-900 mb-4">connect()</h3>
      <p class="text-lg text-gray-700 mb-4">
        Connect to an SSE endpoint for cache invalidation and preload hints.
      </p>

      <div class="bg-amber-50 rounded-xl p-6 mb-4">
        <h4 class="font-bold text-gray-900 mb-2">Signature:</h4>
        <Code code={connectSignatureCode} lang="ts" />
      </div>

      <div class="bg-amber-50 rounded-xl p-6 mb-4">
        <h4 class="font-bold text-gray-900 mb-2">Usage:</h4>
        <Code code={connectUsageCode} lang="js" />
      </div>

      <div class="bg-red-100 rounded-xl p-4">
        <p class="text-sm text-red-900">
          <strong>Automatic tracking:</strong> The client sends its last sync timestamp to minimize unnecessary preloading.
        </p>
      </div>
    </div>

    <!-- Connection -->
    <div class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-2xl p-8 border-4 border-yellow-500">
      <h3 class="text-3xl font-bold text-yellow-900 mb-4">Connection</h3>
      <p class="text-lg text-gray-700 mb-4">
        Wrapper around EventSource with a clean close() method.
      </p>

      <div class="bg-amber-50 rounded-xl p-6">
        <h4 class="font-bold text-gray-900 mb-2">Methods:</h4>
        <ul class="space-y-2 text-gray-700">
          <li><code class="bg-yellow-100 px-2 py-1 rounded">close()</code> - Close the SSE connection</li>
        </ul>
      </div>
    </div>
  </div>
</section>
